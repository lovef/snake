<html>
<header>
    <title>Simple Snake</title>
    <style>
        html, body {
            padding: 0; margin: 0;
            overflow:hidden;
        }
        canvas {
            border: 1px solid #000;
        }
    </style>
</header>
<body>
    <canvas id="canvas">Canvas is required for this to work</canvas>
    <label id="score"></label>
    <script>
        var scoreBoard = document.getElementById('score');
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');
        var s = Math.min(window.innerWidth, window.innerHeight) - 2;
        var size = { x: s, y: s }
        context.canvas.width = size.x;
        context.canvas.height = size.y;
        var columns = 20;
        var rows = 20;
        var squareSize = { x: size.x / columns, y: size.y / rows }

        var position = { x: 10, y: 10 };
        var tailLast = { x: 10, y: 10 };
        var velocity = { x: 0, y: 0 };
        var velocityNext = undefined;
        var points = [];
        var apple = undefined;
        var appleInt = undefined;
        var nutrients = 1;
        var toAdd = 0;

        function fill(p) {
            var x = Math.round(p.x * squareSize.x);
            var y = Math.round(p.y * squareSize.y);
            var x1 = Math.round((p.x + 1) * squareSize.x);
            var y1 = Math.round((p.y + 1) * squareSize.y);
            context.fillRect(x, y, x1 - x, y1 - y);
        }

        function clear(p) {
            var x = Math.round(p.x * squareSize.x);
            var y = Math.round(p.y * squareSize.y);
            var x1 = Math.round((p.x + 1) * squareSize.x);
            var y1 = Math.round((p.y + 1) * squareSize.y);
            context.clearRect(x, y, x1 - x, y1 - y);
        }

        function createApple() {
            apple = { x: Math.floor(Math.random() * columns), y: Math.floor(Math.random() * rows) };
            appleInt = pointToInt(apple);
            if (collides(appleInt)){
                apple = undefined;
            } else {
                fill(apple);
            }
        }

        function gameLoop() {
            if(velocityNext) {
                velocity = velocityNext;
                velocityNext = undefined;
            }
            position.x += velocity.x + columns;
            position.y += velocity.y + rows;
            position.x %= columns;
            position.y %= rows;
            var positionInt = pointToInt(position);
            if(collides(positionInt)) {
                window.clearInterval(intervalId);
                context.fillStyle = '#ff0000';
                fill(position);
                return;
            }
            points.push(positionInt);
            if (positionInt == appleInt) {
                apple = undefined;
                toAdd += nutrients - 1;
                nutrients++;
            } else if(toAdd > 0) {
                toAdd--;
            } else {
                var tailPointInt = points.shift();
                if (tailPointInt != pointToInt(tailLast)) {
                    clear(tailLast);
                    tailLast = intToPoint(tailPointInt);
                }
            }
            // Draw last to ensure boxes aren't cleared
            fill(position);
            if(!apple) {
                createApple();
            }
            scoreBoard.textContent = points.length;
        }

        function collides(pInt) {
            return points.indexOf(pInt) >= 0;
        }
        function pointToInt(p) {
            return p.x + p.y * columns;
        }
        function intToPoint(i) {
            var x = i % columns;
            return { x: x, y: (i - x) / columns };
        }

        document.addEventListener('keydown', function(e) {
            switch(e.code) {
                case 'ArrowLeft': if(velocity.x == 0) velocityNext = { x: -1, y: 0 }; break;
                case 'ArrowRight': if(velocity.x == 0) velocityNext = { x: 1, y: 0 }; break;
                case 'ArrowUp': if(velocity.y == 0) velocityNext = { x: 0, y: -1 }; break;
                case 'ArrowDown': if(velocity.y == 0) velocityNext = { x: 0, y: 1 }; break;
            }
        })

        canvas.onmousedown = function(e){
            if(velocity.x == 0) {
                var left = e.x / size.x < 0.5;
                velocity.x = left ? -1 : 1; velocity.y = 0;
            } else if(velocity.y == 0) {
                var down = e.y / size.y < 0.5;
                velocity.x = 0; velocity.y = down ? -1 : 1;
            }
        }

        window.addEventListener('resize', function(e) {
            var size = Math.min(window.innerWidth, window.innerHeight) - 2;
            context.canvas.width = size;
            context.canvas.height = size;
        })

        var intervalId = window.setInterval(gameLoop, 100);
    </script>
</body>