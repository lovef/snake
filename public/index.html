<html>
<header>
    <title>Simple Snake</title>
    <style>
        html, body {
            padding: 0; margin: 0;
            overflow:hidden;
        }
        canvas {
            border: 1px solid #000;
        }
    </style>
</header>
<body>
    <canvas id="canvas">Canvas is required for this to work</canvas>
    <label id="score"></label>
    <script>
        var pixels = Math.min(window.innerWidth, window.innerHeight) - 2;
        var scoreBoard = document.getElementById('score');
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');
        context.canvas.width = pixels;
        context.canvas.height = pixels;

        var size = 30;
        var boxSize = pixels / size;

        var position = { x: size / 2, y: size / 2 };
        var tailLast = { x: size / 2, y: size / 2 };
        var velocity = { x: 0, y: 0 };
        var velocityNext = undefined;
        var points = [];
        var apple = undefined;
        var appleInt = undefined;
        var nutrients = 1;
        var toAdd = 0;

        function fill(p) {
            var x = Math.round(p.x * boxSize);
            var y = Math.round(p.y * boxSize);
            var x1 = Math.round((p.x + 1) * boxSize);
            var y1 = Math.round((p.y + 1) * boxSize);
            context.fillRect(x, y, x1 - x, y1 - y);
        }

        function clear(p) {
            var x = Math.round(p.x * boxSize);
            var y = Math.round(p.y * boxSize);
            var x1 = Math.round((p.x + 1) * boxSize);
            var y1 = Math.round((p.y + 1) * boxSize);
            context.clearRect(x, y, x1 - x, y1 - y);
        }

        function createApple() {
            apple = { x: Math.floor(Math.random() * size), y: Math.floor(Math.random() * size) };
            appleInt = pointToInt(apple);
            if (collides(appleInt)){
                apple = undefined;
            } else {
                fill(apple);
            }
        }

        function gameLoop() {
            if(velocityNext) {
                velocity = velocityNext;
                velocityNext = undefined;
            }
            position.x = (position.x + velocity.x + size) % size;
            position.y = (position.y + velocity.y + size) % size;
            var positionInt = pointToInt(position);
            if(collides(positionInt)) {
                gameOver();
                return;
            }
            points.push(positionInt);
            if (positionInt == appleInt) {
                apple = undefined;
                toAdd += nutrients - 1;
                nutrients++;
            } else if(toAdd > 0) {
                toAdd--;
            } else {
                var tailPointInt = points.shift();
                if (tailPointInt != pointToInt(tailLast)) {
                    clear(tailLast);
                    tailLast = intToPoint(tailPointInt);
                }
            }
            // Draw last to ensure boxes aren't cleared
            fill(position);
            if(!apple) {
                createApple();
            }
            scoreBoard.textContent = points.length;
        }

        function gameOver() {
                window.clearInterval(intervalId);
                context.fillStyle = '#ff0000';
                fill(position);
        }

        function collides(pInt) {
            return points.indexOf(pInt) >= 0;
        }
        function pointToInt(p) {
            return p.x + p.y * size;
        }
        function intToPoint(i) {
            var x = i % size;
            return { x: x, y: (i - x) / size };
        }

        document.addEventListener('keydown', function(e) {
            switch(e.code) {
                case 'ArrowLeft': if(velocity.x == 0) velocityNext = { x: -1, y: 0 }; break;
                case 'ArrowRight': if(velocity.x == 0) velocityNext = { x: 1, y: 0 }; break;
                case 'ArrowUp': if(velocity.y == 0) velocityNext = { x: 0, y: -1 }; break;
                case 'ArrowDown': if(velocity.y == 0) velocityNext = { x: 0, y: 1 }; break;
            }
        })

        canvas.onmousedown = function(e){
            if(velocity.x == 0) {
                var left = e.x / pixels < 0.5;
                velocity.x = left ? -1 : 1; velocity.y = 0;
            } else if(velocity.y == 0) {
                var down = e.y / pixels < 0.5;
                velocity.x = 0; velocity.y = down ? -1 : 1;
            }
        }

        window.addEventListener('resize', function(e) {
            var size = Math.min(window.innerWidth, window.innerHeight) - 2;
            context.canvas.width = size;
            context.canvas.height = size;
        })

        var intervalId = window.setInterval(gameLoop, 100);
    </script>
</body>