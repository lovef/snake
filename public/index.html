<html>
<header>
    <title>Simple Snake</title>
    <style>
        canvas {
            border: 1px solid #000;
        }
    </style>
</header>
<body>
    <canvas id="canvas" width="400" height="400">Canvas is required for this to work</canvas>
    <label id="score"></label>
    <script>
        var scoreBoard = document.getElementById('score');
        var context = document.getElementById('canvas').getContext('2d');
        var size = { x: 400, y: 400 }
        var columns = 20;
        var rows = 20;
        var squareSize = { x: size.x / columns, y: size.y / rows }

        var position = { x: 10, y: 10};
        var tailLast = position;
        var velocity = { x: 0, y: 0 };
        var points = [];
        var apple = undefined;
        var appleInt = undefined;

        function fill(p) {
            context.fillRect(p.x * squareSize.x, p.y * squareSize.y, squareSize.x, squareSize.y);
        }
        var position = { x: 10, y: 10}

        function clear(p) {
            context.clearRect(p.x * squareSize.x, p.y * squareSize.y, squareSize.x, squareSize.y);
        }

        function createApple() {
            apple = { x: Math.floor(Math.random() * columns), y: Math.floor(Math.random() * rows) };
            appleInt = pointToInt(apple);
            if (collides(appleInt)){
                console.log("Apple collides, ignore");
                apple = undefined;
            } else {
                fill(apple);
            }
        }

        function game() {
            if(!apple) {
                createApple();
            }
            position.x += velocity.x + columns;
            position.y += velocity.y + rows;
            position.x %= columns;
            position.y %= rows;
            var positionInt = pointToInt(position);
            if(collides(positionInt)) {
                window.clearInterval(intervalId);
                context.fillStyle = '#ff0000';
                fill(position);
                return;
            }
            fill(position);
            points.push(positionInt);
            if (positionInt == appleInt) {
                apple = undefined;
            } else {
                var tailPointInt = points.shift();
                if (tailPointInt != pointToInt(tailLast)) {
                    clear(tailLast);
                    tailLast = intToPoint(tailPointInt);
                }
            }
            scoreBoard.textContent = points.length;
        }

        function collides(pInt) {
            return points.indexOf(pInt) >= 0;
        }
        function pointToInt(p) {
            return p.x + p.y * columns;
        }
        function intToPoint(i) {
            var x = i % columns;
            return { x: x, y: (i - x) / columns };
        }

        document.addEventListener('keydown', function(e) {
            switch(e.code) {
                case 'ArrowLeft': if(velocity.x == 0) { velocity.x = -1; velocity.y = 0; } break;
                case 'ArrowRight': if(velocity.x == 0) { velocity.x = 1; velocity.y = 0; } break;
                case 'ArrowUp': if(velocity.y == 0) { velocity.x = 0; velocity.y = -1; } break;
                case 'ArrowDown': if(velocity.y == 0) { velocity.x = 0; velocity.y = 1; } break;
            }
        })

        var intervalId = window.setInterval(game, 100);
    </script>
</body>